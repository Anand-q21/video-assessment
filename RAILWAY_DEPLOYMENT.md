# Railway Deployment Guide

## Setting Up MySQL Database on Railway

### 1. Add MySQL Database

1. Go to your Railway project dashboard
2. Click **"+ New"** ‚Üí **"Database"** ‚Üí **"Add MySQL"**
3. Railway will create a MySQL database and generate credentials

### 2. Configure Environment Variables

In your Railway service, go to **Variables** tab and add:

```bash
# Reference the MySQL database (Railway auto-connects services)
DATABASE_URL=${{MySQL.DATABASE_URL}}

# Production settings
APP_ENV=prod
APP_DEBUG=0
APP_SECRET=<generate-a-random-secret-key>

# CORS (update with your frontend domain)
CORS_ALLOW_ORIGIN=*

# JWT will be auto-generated by Dockerfile
# No need to set JWT variables

# TRUSTED_PROXIES is auto-configured in Dockerfile
# No need to set it manually
```

### 3. How to Generate APP_SECRET

Run this command locally:
```bash
php -r "echo bin2hex(random_bytes(16));"
```

Copy the output and use it as your `APP_SECRET` in Railway.

### 4. Deploy

Once you push to GitHub, Railway will:
- ‚úÖ Build the Docker image
- ‚úÖ Auto-generate JWT keys
- ‚úÖ Connect to MySQL database
- ‚úÖ Run migrations automatically
- ‚úÖ Start the application

## Local Development Setup

### 1. Create `.env.local` file

```bash
cp .env.example .env.local
```

### 2. Update `.env.local` with your local MySQL credentials

```env
APP_ENV=dev
APP_DEBUG=1
APP_SECRET=your-local-secret

DATABASE_URL="mysql://root:your-password@127.0.0.1:3306/assessment_project?serverVersion=8.0&charset=utf8mb4"

JWT_PASSPHRASE=your-jwt-passphrase
```

### 3. Generate JWT Keys (if not already done)

```bash
php bin/console lexik:jwt:generate-keypair
```

### 4. Run Migrations

```bash
php bin/console doctrine:database:create
php bin/console doctrine:migrations:migrate
```

## Security Notes

‚ö†Ô∏è **NEVER commit these files with real credentials:**
- `.env.local` (gitignored)
- `config/jwt/private.pem` (gitignored)
- `config/jwt/public.pem` (gitignored)

‚úÖ **Safe to commit:**
- `.env` (with placeholder values only)
- `.env.example` (example configuration)
- `Dockerfile` (no secrets)

## Environment Variable Priority

Symfony loads environment variables in this order (later overrides earlier):
1. `.env` - Default values (committed to git)
2. `.env.local` - Local overrides (gitignored, for your machine)
3. `.env.prod` - Production defaults (committed to git)
4. Railway environment variables - Highest priority (set in Railway dashboard)

## üîß Troubleshooting

### "DNS_PROBE_FINISHED_NXDOMAIN" Error
If you see this error, it means **the URL you are trying to access no longer exists**.
- Railway often generates a **NEW** random domain when you redeploy or recreate a service.
- **Solution:**
  1. Close "Project Settings" if open.
  2. **Make sure you click the `video-platform-api` service** (NOT the MySQL database service).
  3. Click the **Settings** tab *inside* that service view.
  4. Scroll to **Networking** and click **Generate Domain** (if none exists) or the **current** domain link.

### "500 Internal Server Error"
- Check the **Deployments** logs in Railway.
- Ensure `DATABASE_URL` is set correctly.
- Ensure `APP_ENV=prod`.

### "Application Error" or "502 Bad Gateway"
- The application failed to start.
- Check logs for "Fatal Error" or "Stopping Container".
- Ensure `start.sh` is binding to `[::]:$PORT`.
